<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <title>Sample Viewer - Card Style</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 1200px;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .top-section, .bottom-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .top-section .card {
            flex: 1 1 30%;
            min-width: 250px;
        }

        .bottom-section .card {
            flex: 1 1 48%;
            min-height: 550px;
        }

        .selector-container {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .selector-container label {
            margin-right: 10px;
            font-weight: normal; /* 不加粗 */
            color: #666666; /* 灰色字体 */
            white-space: nowrap;
        }


        select, input[type="text"], input[type="number"] {
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex: 1;
        }

        .image-container img {
            width: 100%;
            max-height: 400px;
            height: auto;
            border-radius: 6px;
        }

        .question-container h4 {
            margin-top: -5px;
            margin-bottom: 10px;
            font-weight: normal; /* 去除加粗 */
            color: #666666; /* 设置为灰色 */
        }

        .answer-container h4 {
            margin-top: 25px;
            margin-bottom: 10px;
            font-weight: normal; /* 去除加粗 */
            color: #666666; /* 设置为灰色 */
        }

        .question-container p,
        .answer-container p {
            letter-spacing: 0.5px; /* 字符之间间距 */
            line-height: 1.4; /* 行高（垂直间距） */
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background-color: transparent;
        }

        .image-with-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ImagePath 专用样式 */
        .full-width-input {
            width: 100%;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Top Section -->
    <div class="top-section">
        <div class="card">
            <div class="selector-container">
                <label for="category">Defect Type</label>
                <select id="category" class="dropdown">
                    <option value="Single Defect">Single Defect</option>
                    <option value="No Defect">No Defect</option>
                    <option value="Multiple Defect">Multiple Defect</option>
                    <option value="Logical Defect">Logical Defect</option>
                </select>
            </div>
        </div>
        <div class="card">
            <div class="selector-container">
                <label for="sample-index">Sample Index</label>
                <input type="number" id="sample-index" value="0" min="0"/>
            </div>
        </div>
        <div class="card">
            <div class="selector-container">
                <label for="total-samples">Total Samples</label>
                <input type="text" id="total-samples" value="200" readonly/>
            </div>
        </div>
    </div>

    <!-- Bottom Section -->
    <div class="bottom-section">
        <!-- Image Card -->
        <div class="card image-with-info">
            <div class="image-container">
                <img src="pic/1.png" alt="Sample Image"/>
            </div>
            <div class="selector-container">
                <label for="ImagePath">ImagePath</label>
                <input type="text" id="ImagePath" value="MIAD/catenary_dropper/999.png" readonly
                       class="full-width-input"/>
            </div>
        </div>

        <!-- QA Card -->
        <div class="card">
            <div class="question-container">
                <h4><i class="fas fa-question-circle" style="margin-right: 8px; color: #007BFF;"></i>Question</h4>
                <p></p>
            </div>
            <div class="answer-container">
                <h4><i class="fas fa-lightbulb" style="margin-right: 8px; color: #FFC107;"></i>Analysis</h4>
                <p></p>
            </div>
            <div class="answer-container">
                <h4><i class="fas fa-check-circle" style="margin-right: 8px; color: #28A745;"></i>Answer</h4>
                <p></p>
            </div>
        </div>

    </div>
</div>
</body>
<script>
    const totalSamplesMap = {
        "Single Defect": 200,
        "No Defect": 200,
        "Multiple Defect": 20,
        "Logical Defect": 10
    };

    function updateContent() {
        const category = document.getElementById('category').value;
        const indexInput = document.getElementById('sample-index');
        const index = indexInput.value.padStart(3, '0');
        const total = totalSamplesMap[category] || 0;

        // 更新总数与 max 限制
        document.getElementById('total-samples').value = total;
        indexInput.max = total - 1;

        const basePath = `output/${category}/${index}`;
        const img = document.querySelector('.image-container img');
        const jsonPath = `${basePath}.json`;
        const tryExtensions = ['.jpg', '.png'];

        // 尝试加载图像
        function tryLoadImage(i = 0) {
            if (i >= tryExtensions.length) {
                img.src = '';
                document.getElementById('ImagePath').value = 'Image not found';
                return;
            }

            const imgPath = `${basePath}${tryExtensions[i]}`;
            const testImg = new Image();
            testImg.onload = () => {
                img.src = imgPath;
            };
            testImg.onerror = () => tryLoadImage(i + 1);
            testImg.src = imgPath;
        }

        tryLoadImage(); // 从第一个格式开始尝试

        fetch(jsonPath)
            .then(res => {
                if (!res.ok) throw new Error("JSON not found");
                return res.json();
            })
            .then(data => {
                const conv = data.conversation || {};

                const rawQuestion = conv.Question || 'No question available.';

// 去掉最后一个字符
                let cleanedQuestion = rawQuestion.slice(0, -1);

// 将第一个 '(' 保留，后续每个 '(' 前插入空格
                let firstIndex = cleanedQuestion.indexOf('(');
                if (firstIndex !== -1) {
                    cleanedQuestion =
                        cleanedQuestion.slice(0, firstIndex + 1) +
                        cleanedQuestion.slice(firstIndex + 1).replace(/\(/g, ' (');
                }
// 替换 \n 为 <br>
                cleanedQuestion = cleanedQuestion.replace(/\n/g, '<br>');
// 应用到页面
                document.querySelector('.question-container p').innerHTML = cleanedQuestion;
                document.querySelectorAll('.answer-container p')[1].textContent = conv.Answer || 'No answer.';
                document.querySelectorAll('.answer-container p')[0].textContent = conv.Reasoning || 'No analysis.';
                document.getElementById('ImagePath').value = data.image_path || img.src;
            })
            .catch(() => {
                document.querySelector('.question-container p').textContent = 'No question available.';
                document.querySelectorAll('.answer-container p')[1].textContent = 'No answer.';
                document.querySelectorAll('.answer-container p')[0].textContent = 'No analysis.';
                document.getElementById('ImagePath').value = 'JSON not found';
            });
    }

    document.getElementById('category').addEventListener('change', updateContent);
    document.getElementById('sample-index').addEventListener('input', updateContent);
    window.addEventListener('DOMContentLoaded', updateContent);
</script>
</html>
